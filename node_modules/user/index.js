var md5 = require('md5');

var connection = function(req, res){
    var pg = require('pg');
    pg.defaults.ssl = true;
    var resSend = false;
    pg.connect("postgres://iqohxmivsnsekz:83aeedca145e9d4c835c84cae8b2a3145416435e78c3c5ce82152b4c3e57c6d7@ec2-54-83-205-71.compute-1.amazonaws.com:5432/ddmteemcfd95nl"
    ,function(err, client) {
      if (err) throw err;
      client
        .query("SELECT * FROM public.user where mailadress = $1;",[req.body.mailadress])
        .on('row', function(row) {
          if(row.password == md5(req.body.password)){
            resSend = true;
            res.send(JSON.stringify(row));
          }
          else {
            resSend = true;
            res.send({error: 'Mauvais identifiants'});
          }
        })
        .on("end", function(result){
          if(!resSend){
            res.send({error: 'Mauvais identifiants'});
          }
        });
    });
}

function makeCodeCookie(taille)
{
  var text = "";
  var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  for( var i=0; i < taille; i++ ){
      text += possible.charAt(Math.floor(Math.random() * possible.length));
  }
  return text;
}

var inscription = function(req, res){
    var pg = require('pg');
    pg.defaults.ssl = true;
    var newUser = req.body;
    newUser.cookiecode = makeCodeCookie(30);
    pg.connect("postgres://iqohxmivsnsekz:83aeedca145e9d4c835c84cae8b2a3145416435e78c3c5ce82152b4c3e57c6d7@ec2-54-83-205-71.compute-1.amazonaws.com:5432/ddmteemcfd95nl"
    ,function(err, client) {
      if (err) throw err;
      client
        .query("INSERT into public.user (lastname,firstname,mailadress,password,registration,lastconnection,cookiecode,sexe,birthdate)values($1,$2,$3,$4,NOW(),NOW(),$5,$6,$7);"
        ,[newUser.lastname, newUser.firstname, newUser.mailadress, md5(newUser.password), newUser.cookiecode, newUser.sexe, newUser.birthdate])
        .on("end", function(result){
          res.send(newUser);
        });
    });
}

var champComplet = function(req){
  return("sexe" in req.body
    && "lastname" in req.body
    && "firstname" in req.body
    && "mailadress" in req.body
    && "birthdate" in req.body
    && "password" in req.body
    && "passwordbis" in req.body);
}

var verifInscription = function(req,res,next){
  var pg = require('pg');
  pg.defaults.ssl = true;
  var resSend = false;
  pg.connect("postgres://iqohxmivsnsekz:83aeedca145e9d4c835c84cae8b2a3145416435e78c3c5ce82152b4c3e57c6d7@ec2-54-83-205-71.compute-1.amazonaws.com:5432/ddmteemcfd95nl"
  ,function(err, client) {
    if (err) throw err;
    client
      .query("SELECT * FROM public.user where mailadress = $1;",[req.body.mailadress])
      .on("end", function(result){
        if(result.rowCount == 0){
          if(champComplet(req))
          {
            next();
          }
          else {
            res.send({error: 'Des champs sont vides.'});
          }
        }
        else{
          res.send({error: 'Cette adresse mail est déjà utilisée.'});
        }
      });
  });
}

exports.connection = connection;
exports.inscription = inscription;
exports.verifInscription = verifInscription;
